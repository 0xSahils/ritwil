generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  S1_ADMIN
  SUPER_ADMIN
  TEAM_LEAD
  LIMITED_ACCESS
  EMPLOYEE
}

enum TargetType {
  REVENUE
  PLACEMENTS
}

enum PlacementType {
  PERMANENT
  CONTRACT
}

enum BillingStatus {
  PENDING
  BILLED
  CANCELLED
  HOLD
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  COMPLETED
  ARCHIVED
}

model Team {
  id           String            @id @default(cuid())
  name         String            @unique
  color        String?
  yearlyTarget Decimal           @db.Decimal(14, 2)
  isActive     Boolean           @default(true)
  employees    EmployeeProfile[]
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  
  campaignId   String?
  campaign     Campaign?         @relation(fields: [campaignId], references: [id])

  @@index([isActive])
  @@index([campaignId])
}

model User {
  id             String            @id @default(cuid())
  email          String            @unique
  passwordHash   String
  name           String
  role           Role
  isActive       Boolean           @default(true)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  employeeProfile EmployeeProfile?
  refreshTokens  RefreshToken[]
  dailyEntries   DailyEntry[]
  placements     Placement[]
  incentives     Incentive[]
  campaignAssignments CampaignAssignment[]
  campaignTeamLeads   CampaignTeamLead[]
  campaignActivities  CampaignActivity[]
  createdCampaigns    Campaign[]        @relation("CampaignCreatedBy")
  uploadedCampaignImages CampaignImage[] @relation("CampaignImageUploadedBy")
  completedCampaignTasks CampaignTask[]  @relation("CampaignTaskCompletedBy")

  leadEmployees EmployeeProfile[] @relation("LeadEmployees")

  // Security
  mfaSecret    String?
  mfaEnabled   Boolean           @default(false)
  
  // Hierarchy
  managerId    String?
  manager      User?             @relation("UserHierarchy", fields: [managerId], references: [id])
  subordinates User[]            @relation("UserHierarchy")

  auditLogs     AuditLog[]

  @@index([role])
  @@index([isActive])
}

model EmployeeProfile {
  id           String  @id
  user         User    @relation(fields: [id], references: [id])
  teamId       String?
  team         Team?   @relation(fields: [teamId], references: [id])
  managerId    String?
  manager      User?   @relation("LeadEmployees", fields: [managerId], references: [id])
  level        String?
  vbid         String?
  yearlyTarget  Decimal        @db.Decimal(14, 2)
  yearlyRevenueTarget Decimal? @db.Decimal(14, 2)
  yearlyPlacementTarget Decimal? @db.Decimal(14, 2)
  slabQualified String?
  targetType    TargetType     @default(REVENUE)
  isActive      Boolean        @default(true)
  deletedAt    DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([teamId])
  @@index([managerId])
  @@index([isActive])
}

model DailyEntry {
  id            String         @id @default(cuid())
  employeeId    String
  employee      User           @relation(fields: [employeeId], references: [id])
  date          DateTime
  clientName    String
  placementType PlacementType
  revenue       Decimal        @db.Decimal(14, 2)
  marginPercent Decimal        @db.Decimal(5, 2)
  billingStatus BillingStatus
  doi           DateTime
  doj           DateTime
  remarks       String?
  createdAt     DateTime       @default(now())

  @@index([employeeId, date])
  @@index([billingStatus])
}

model Placement {
  id                 String         @id @default(cuid())
  employeeId         String
  employee           User           @relation(fields: [employeeId], references: [id])
  candidateName      String
  candidateId        String?
  clientId           String?
  jpcId              String?
  clientName         String
  recruiter          String?
  sourcer            String?
  accountManager     String?
  teamLead           String?
  placementSharing   String?
  placementCredit    Decimal?       @db.Decimal(5, 2)
  totalRevenue       Decimal?       @db.Decimal(14, 2)
  revenueAsLead      Decimal?       @db.Decimal(14, 2)
  doi                DateTime?
  doj                DateTime
  doq                DateTime?
  daysCompleted      Int?
  placementType      PlacementType
  billedHours        Int?
  marginPercent      Decimal        @db.Decimal(5, 2)
  revenue            Decimal        @db.Decimal(14, 2)
  billingStatus      BillingStatus
  incentivePayoutEta DateTime?
  incentiveAmountInr Decimal        @db.Decimal(14, 2)
  incentivePaid      Boolean
  qualifier          Boolean
  createdAt          DateTime       @default(now())

  monthlyBillings MonthlyBilling[]

  @@unique([employeeId, candidateName, clientName, doj])
  @@index([employeeId])
  @@index([billingStatus])
}

model MonthlyBilling {
  id          String        @id @default(cuid())
  placementId String
  placement   Placement     @relation(fields: [placementId], references: [id])
  month       String
  hours       Int?
  status      BillingStatus

  @@index([placementId])
  @@index([status])
}

model Incentive {
  id           String   @id @default(cuid())
  employeeId   String
  employee     User     @relation(fields: [employeeId], references: [id])
  periodStart  DateTime
  periodEnd    DateTime
  revenueTotal Decimal  @db.Decimal(14, 2)
  slabName     String
  amountUsd    Decimal  @db.Decimal(14, 2)
  amountInr    Decimal  @db.Decimal(14, 2)
  createdAt    DateTime @default(now())

  @@index([employeeId, periodStart, periodEnd])
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  isRevoked Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
}

model Campaign {
  id           String          @id @default(cuid())
  name         String
  description  String?
  objective    String?
  status       CampaignStatus  @default(DRAFT)
  targetAmount Decimal         @db.Decimal(14, 2)
  startDate    DateTime
  endDate      DateTime
  createdById  String
  createdBy    User            @relation("CampaignCreatedBy", fields: [createdById], references: [id])
  images       CampaignImage[]
  teamLeads    CampaignTeamLead[]
  assignments  CampaignAssignment[]
  teams        Team[]
  tasks        CampaignTask[]
  activities   CampaignActivity[]
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  @@index([status])
  @@index([startDate, endDate])
}

model CampaignImage {
  id          String   @id @default(cuid())
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id])
  url         String
  title       String?
  description String?
  uploadedById String
  uploadedBy  User     @relation("CampaignImageUploadedBy", fields: [uploadedById], references: [id])
  createdAt   DateTime @default(now())

  @@index([campaignId])
}

model CampaignTeamLead {
  id         String   @id @default(cuid())
  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id])
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  createdAt  DateTime @default(now())

  @@unique([campaignId, userId])
  @@index([userId])
}

model CampaignAssignment {
  id             String   @id @default(cuid())
  campaignId     String
  campaign       Campaign @relation(fields: [campaignId], references: [id])
  userId         String
  user           User     @relation(fields: [userId], references: [id])
  role           Role
  targetAmount   Decimal  @db.Decimal(14, 2)
  progressPercent Int      @default(0)
  isCompleted    Boolean  @default(false)
  completedAt    DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tasks CampaignTask[]

  @@index([campaignId])
  @@index([userId])
}

model CampaignTask {
  id              String             @id @default(cuid())
  campaignId      String
  campaign        Campaign           @relation(fields: [campaignId], references: [id])
  assignmentId    String?
  assignment      CampaignAssignment? @relation(fields: [assignmentId], references: [id])
  title           String
  description     String?
  isCompleted     Boolean            @default(false)
  completedById   String?
  completedBy     User?              @relation("CampaignTaskCompletedBy", fields: [completedById], references: [id])
  dueDate         DateTime?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@index([campaignId])
  @@index([assignmentId])
}

model CampaignActivity {
  id         String   @id @default(cuid())
  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id])
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  action     String
  metadata   Json?
  createdAt  DateTime @default(now())

  @@index([campaignId])
  @@index([userId])
}

model AuditLog {
  id         String   @id @default(cuid())
  actorId    String
  actor      User     @relation(fields: [actorId], references: [id])
  action     String
  module     String?
  entityType String
  entityId   String
  changes    Json?
  createdAt  DateTime @default(now())
  
  // Security
  isTampered Boolean  @default(false)
  hash       String?

  @@index([actorId])
  @@index([entityType, entityId])
}

