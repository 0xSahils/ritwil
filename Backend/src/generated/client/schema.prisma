generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  S1_ADMIN
  SUPER_ADMIN
  TEAM_LEAD
  LIMITED_ACCESS
  EMPLOYEE
}

enum TargetType {
  REVENUE
  PLACEMENTS
}

enum PlacementType {
  PERMANENT
  CONTRACT
}

enum BillingStatus {
  PENDING
  BILLED
  CANCELLED
  HOLD
}

model Team {
  id           String            @id @default(cuid())
  name         String            @unique
  color        String?
  yearlyTarget Decimal           @db.Decimal(14, 2)
  isActive     Boolean           @default(true)
  employees    EmployeeProfile[]
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  @@index([isActive])
}

model User {
  id              String           @id @default(cuid())
  email           String           @unique
  passwordHash    String
  name            String
  /// Denormalized from EmployeeProfile; canonical unique VBID is on EmployeeProfile.
  vbid            String?
  role            Role
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  employeeProfile EmployeeProfile?
  refreshTokens   RefreshToken[]

  leadEmployees EmployeeProfile[] @relation("LeadEmployees")

  // Security
  mfaSecret  String?
  mfaEnabled Boolean @default(false)

  // Hierarchy
  managerId    String?
  manager      User?   @relation("UserHierarchy", fields: [managerId], references: [id])
  subordinates User[]  @relation("UserHierarchy")

  auditLogs AuditLog[]

  // Placement import relations
  placementImportBatches PlacementImportBatch[] @relation("UserPlacementImportBatches")
  personalPlacements     PersonalPlacement[]
  teamPlacements         TeamPlacement[]
  passwordResetTokens    PasswordResetToken[]

  @@index([role])
  @@index([isActive])
}

/// One-time tokens for forgot-password flow. Token is stored hashed; expiry typically 1 hour.
model PasswordResetToken {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
}

model EmployeeProfile {
  id         String     @id
  user       User       @relation(fields: [id], references: [id])
  teamId     String?
  team       Team?      @relation(fields: [teamId], references: [id])
  managerId  String?
  manager    User?      @relation("LeadEmployees", fields: [managerId], references: [id])
  level      String?
  /// VBID is unique per profile (null allowed; non-null values must be unique across all users).
  vbid       String?    @unique
  /// Admin-written comment shown in L4 dashboard slab box
  comment    String?
  targetType TargetType @default(REVENUE)
  isActive   Boolean    @default(true)
  deletedAt  DateTime?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  @@index([teamId])
  @@index([managerId])
  @@index([isActive])
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  isRevoked Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
}

model AuditLog {
  id          String   @id @default(cuid())
  actorId     String?
  actor       User?    @relation(fields: [actorId], references: [id])
  action      String
  module      String?
  entityType  String?
  entityId    String?
  changes     Json?
  status      String   @default("SUCCESS")
  ipAddress   String?
  userAgent   String?
  geoLocation String?
  createdAt   DateTime @default(now())

  // Security
  isTampered Boolean @default(false)
  hash       String?

  @@index([actorId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
}

/// Import type for placement Excel uploads
enum PlacementImportType {
  PERSONAL
  TEAM
}

/// Represents a single uploaded placement sheet (personal or team)
model PlacementImportBatch {
  id         String              @id @default(cuid())
  type       PlacementImportType
  uploaderId String
  uploader   User                @relation("UserPlacementImportBatches", fields: [uploaderId], references: [id])
  createdAt  DateTime            @default(now())
  /// Row-level validation errors: [{ rowIndex, message, field? }]
  errors     Json?

  personalPlacements PersonalPlacement[]
  teamPlacements     TeamPlacement[]

  @@index([type])
  @@index([uploaderId])
}

/// Row-level data for Members Placement Import (personal placements)
model PersonalPlacement {
  id String @id @default(cuid())

  // Relations
  employeeId String
  employee   User   @relation(fields: [employeeId], references: [id])

  batchId String?
  batch   PlacementImportBatch? @relation(fields: [batchId], references: [id])

  // Core placement fields (per row)
  level            String? // L1, L2, L3, L4 - for data separation
  candidateName    String
  placementYear    Int?
  doj              DateTime
  doq              DateTime?
  client           String
  plcId            String
  placementType    String
  billingStatus    String
  collectionStatus String?
  totalBilledHours Int?
  revenueUsd       Decimal   @db.Decimal(14, 2)
  incentiveInr     Decimal   @db.Decimal(14, 2)
  incentivePaidInr Decimal?  @db.Decimal(14, 2)

  // Summary snapshot fields from sheet (copied as-is)
  vbCode                String?
  recruiterName         String?
  teamLeadName          String?
  yearlyPlacementTarget Decimal? @db.Decimal(14, 2)
  placementDone         Decimal? @db.Decimal(14, 2)
  targetAchievedPercent Decimal? @db.Decimal(5, 2)
  totalRevenueGenerated Decimal? @db.Decimal(14, 2)
  slabQualified         String?
  totalIncentiveInr     Decimal? @db.Decimal(14, 2)
  totalIncentivePaidInr Decimal? @db.Decimal(14, 2)

  createdAt DateTime @default(now())

  @@index([employeeId])
  @@index([placementYear])
  @@index([plcId])
}

/// Row-level data for Team Lead Placement Import (team placements)
model TeamPlacement {
  id String @id @default(cuid())

  // Relations
  leadId String
  lead   User   @relation(fields: [leadId], references: [id])

  batchId String?
  batch   PlacementImportBatch? @relation(fields: [batchId], references: [id])

  // Core placement fields (per row)
  level            String? // L1, L2, L3, L4 - for data separation
  candidateName    String
  recruiterName    String?
  leadName         String?
  splitWith        String?
  placementYear    Int?
  doj              DateTime
  doq              DateTime?
  client           String
  plcId            String
  placementType    String
  billingStatus    String
  collectionStatus String?
  totalBilledHours Int?
  revenueLeadUsd   Decimal   @db.Decimal(14, 2)
  incentiveInr     Decimal   @db.Decimal(14, 2)
  incentivePaidInr Decimal?  @db.Decimal(14, 2)

  // Summary snapshot fields from sheet (team-level)
  vbCode                       String?
  yearlyPlacementTarget        Decimal? @db.Decimal(14, 2)
  placementDone                Decimal? @db.Decimal(14, 2)
  placementAchPercent          Decimal? @db.Decimal(5, 2)
  yearlyRevenueTarget          Decimal? @db.Decimal(14, 2)
  revenueAch                   Decimal? @db.Decimal(14, 2)
  revenueTargetAchievedPercent Decimal? @db.Decimal(5, 2)
  totalRevenueGenerated        Decimal? @db.Decimal(14, 2)
  slabQualified                String?
  totalIncentiveInr            Decimal? @db.Decimal(14, 2)
  totalIncentivePaidInr        Decimal? @db.Decimal(14, 2)

  createdAt DateTime @default(now())

  @@index([leadId])
  @@index([placementYear])
  @@index([plcId])
}
